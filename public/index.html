<!DOCTYPE html>
<html lang="en">
<head>
    <title>Socket.IO chat</title>
    <style>
        body {
            margin: 0;
            padding-bottom: 3rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #listGroup {
            flex-direction: column;
        }

        #room {
            background: rgba(0, 0, 0, 0.15);
            padding: 0.25rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            height: 3rem;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        #inputSearchGroup {
            border: none;
            padding: 0 1rem;
            flex-grow: 1;
            border-radius: 2rem;
            margin: 0.25rem;
        }

        #inputSearchGroup:focus {
            outline: none;
        }

        #room > button {
            background: #333;
            border: none;
            padding: 0 1rem;
            margin: 0.25rem;
            border-radius: 3px;
            outline: none;
            color: #fff;
        }

        #groups {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #groups > li {
            padding: 0.5rem 1rem;
        }

        #groups > li:nth-child(odd) {
            background: #efefef;
        }

        #message {
            background: rgba(0, 0, 0, 0.15);
            padding: 0.25rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            height: 3rem;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        #inputMessage {
            border: none;
            padding: 0 1rem;
            flex-grow: 1;
            border-radius: 2rem;
            margin: 0.25rem;
        }

        #inputMessage:focus {
            outline: none;
        }

        #message > button {
            background: #333;
            border: none;
            padding: 0 1rem;
            margin: 0.25rem;
            border-radius: 3px;
            outline: none;
            color: #fff;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #messages > li {
            padding: 0.5rem 1rem;
        }

        #messages > li:nth-child(odd) {
            background: #efefef;
        }

        .image_user {
            width: 50px;
        }
    </style>
</head>
<body>
<div id="connexion" style="display : flex">
    <form action="" id="login">
        <input id="email" placeholder="Email" type="email" required>
        <input id="pseudo" autocomplete="off" placeholder="Pseudo" required>
        <input type="submit">
    </form>
</div>

<div id="listGroup" style="display : none">
    <form id="searchGroup" action="">
        <input id="inputSearchGroup" autocomplete="off"/>
        <button>search</button>
    </form>
    <ul id="groups">
    </ul>
    <div>
        <ul id="onlineUsers"></ul>
    </div>
</div>

<div id="discussion" style="display : none">
    <div><h1 id="titleRoom"></h1></div>
    <ul id="messages">

    </ul>
    <div>

        <div id="writerArea"></div>
        <form id="message" action="">
            <input id="inputMessage" autocomplete="off"/>
            <button>Send</button>
        </form>
    </div>
</div>


<script src="socket.io.min.js"></script>
<script src="md5.min.js"></script>
<script>
    var listGroup = document.getElementById("listGroup");
    var socket = io("ws://localhost:3000");
    var message = document.getElementById('message');
    var messages = document.getElementById('messages');
    var inputMessage = document.getElementById('inputMessage');
    var login = document.getElementById('login');
    var pseudo = document.getElementById('pseudo');
    var email = document.getElementById('email');
    var writerArea = document.getElementById('writerArea');
    let onlineUsers = document.getElementById('onlineUsers');
    var discussion = document.getElementById('discussion');
    var connexion = document.getElementById('connexion');
    var groups = document.getElementById('groups');
    var titleRoom = document.getElementById('titleRoom');
    var currentGroup;
    let inputSearchGroup = document.getElementById('inputSearchGroup');

    let formData = new FormData ();
    let emailData = formData.get("email");
    let hash = md5(emailData);


    function myMessage(item, msg) {
        item.innerHTML =
            "<div>" +
            "<div><h3>"+ msg["user"] +"</h3></div>" +
            "<div>"+ msg["message"] +"</div>" +
            "</div>"+
            "<div><img class='image_user' src='https://www.gravatar.com/avatar/"+hash+"'></div>";
    }

    function selectRoom() {
        document.querySelectorAll(".room").forEach(function (group) {
            group.addEventListener('click', (e) => {
                e.preventDefault();
                console.log("name room");
                console.log(e.target.id);
                console.log("");
                currentGroup = e.target.id;
                socket.emit('choice group', currentGroup);
                listGroup.style.display = "none";
                discussion.style.display = "flex";
                titleRoom.innerHTML = currentGroup;
            })
        });
    };

    function otherMessage(item, msg){
        item.innerHTML = "<div><img class='image_user' src='https://www.gravatar.com/avatar/"+hash+"'></div>" +
            "<div>" +
            "<div><h3>" + msg["user"] + "</h3></div>" +
            "<div>" + msg["message"] + "</div>" +
            "</div>"
    };

    message.addEventListener('submit', function(e) {
        e.preventDefault();
        if (inputMessage.value) {
            socket.emit('chat message', {
                message: inputMessage.value,
                userMail: email.value,
                user: pseudo.value,
                group: currentGroup
            });
            inputMessage.value = '';
            socket.emit('noWritingUsers', pseudo.value);
            console.log(currentGroup);
            console.log("in sending message ");
        }
    });

    socket.on('chat message', function (msg) {
        let item = document.createElement('li');
        if (email.value === msg['userMail']) {
            myMessage(item, msg);
        } else {
            otherMessage(item, msg);
        }
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
    });

    socket.on('writingUsers', (writers) => {
        if (writers.length !== 0) {
            writerArea.innerHTML = "<div>"
            for (let i = 0; i < writers.length; i++) {
                if (writers[i] !== pseudo.value) {
                    writerArea.innerHTML += writers[i] + ", ";
                }

            }
            writerArea.innerHTML += " is typing.</div>";
        } else {
            writerArea.innerHTML = '';
        }

    });

    socket.on('disconnected', (pseudoDc) => {
        console.log(pseudoDc);
        let item = document.createElement('li');
        item.innerHTML = pseudoDc + " is disconnected";
        messages.appendChild(item);
    });

    login.addEventListener('submit', function(e) {
        e.preventDefault();
        socket.emit('newUser', {
            pseudo: pseudo.value,
            email: email.value,
            img: '',
            socketKey: socket['id'],
            online: true
        });
        listGroup.style.display = "flex";
        connexion.style.display = "none";
    });



    socket.on('draw old messages', (msg) => {

        console.log("in draw old message ");

        for (let i = 0; i < msg.length; i++) {
            console.log(msg[i]['group']);
            let item = document.createElement('li');
            if (email.value === msg[i]['userMail']) {
                myMessage(item, msg[i]);
            } else {
                otherMessage(item, msg[i]);
            }
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        }
        console.log("");
    });

    socket.on('draw groups', (tabGroup) => {
        console.log(tabGroup);
        for (let i = 0; i < tabGroup.length; i++) {
            let item = document.createElement('li');
            item.innerHTML = "<div id='" + tabGroup[i]["name"].toLowerCase() + "'><img class='image_user' id='" + tabGroup[i]["name"].toLowerCase() + "' src='https://static.remove.bg/remove-bg-web/0e54c692cee06c7cdf1bbe6015ddff9e88c6d03a/assets/start-0e837dcc57769db2306d8d659f53555feb500b3c5d456879b9c843d1872e7baa.jpg'/></div>" +
                "<div ><h3 id='" + tabGroup[i]["name"].toLowerCase() + "'>" + tabGroup[i]["name"] + "</h3></div>"

            item.id = tabGroup[i]["name"].toLowerCase();
            item.classList.add("room");
            groups.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);

        }
        selectRoom();

        inputSearchGroup.addEventListener('input', () => {
            let tmp = 0;
            groups.innerHTML = "";
            tabGroup.forEach (group => {

                if (group['name'].toLowerCase().includes(inputSearchGroup.value)){
                    tmp++;
                    let item = document.createElement('li');
                    item.innerHTML += "<div id='" + group["name"].toLowerCase() + "'><img class='image_user' id='" + group["name"].toLowerCase() + "' src='https://static.remove.bg/remove-bg-web/0e54c692cee06c7cdf1bbe6015ddff9e88c6d03a/assets/start-0e837dcc57769db2306d8d659f53555feb500b3c5d456879b9c843d1872e7baa.jpg'/></div>" +
                        "<div ><h3 id='" + group["name"].toLowerCase() + "'>" + group["name"] + "</h3></div>"
                    item.id = group["name"].toLowerCase();
                    item.classList.add("room");
                    groups.appendChild(item);
                    window.scrollTo(0, document.body.scrollHeight);
                }

            })
            if (tmp === 0){
                groups.innerHTML = "<h4>Aucun résultat</h4>"
            }
            selectRoom();
        })

    });

    socket.on('participants', (users) => {
        onlineUsers.innerHTML = "";
        let usersOnline = users.filter(user => user["online"] === true);
        let usersOffline = users.filter(user => user["online"] === false);
        let item = document.createElement('li');
        item.innerHTML = "<h4>Online users</h4>";
        onlineUsers.appendChild(item);
        for (let i = 0; i < usersOnline.length; i++) {
            let item = document.createElement('li');
            item.innerHTML = "<div><img class='image_user' src='https://static.remove.bg/remove-bg-web/0e54c692cee06c7cdf1bbe6015ddff9e88c6d03a/assets/start-0e837dcc57769db2306d8d659f53555feb500b3c5d456879b9c843d1872e7baa.jpg'/></div>" +
                "<div><h3>" + usersOnline[i]["pseudo"] + "</h3></div>";
            onlineUsers.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        };
        item = document.createElement('li');
        item.innerHTML = "<h4>Offline users</h4>";
        onlineUsers.appendChild(item);
        for (let i = 0; i < usersOffline.length; i++) {
            let item = document.createElement('li');
            item.innerHTML = "<div><img class='image_user' src='https://static.remove.bg/remove-bg-web/0e54c692cee06c7cdf1bbe6015ddff9e88c6d03a/assets/start-0e837dcc57769db2306d8d659f53555feb500b3c5d456879b9c843d1872e7baa.jpg'/></div>" +
                "<div><h3>" + usersOffline[i]["pseudo"] + "</h3></div>";
            onlineUsers.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        };

    })

    socket.on('connectedUsers', (users) => {
        let item = document.createElement('li');
        item.innerHTML = users['pseudo'] + " is connected.";
        messages.appendChild(item);
    });

    inputMessage.addEventListener('input', () => {
        console.log("typing");
        if (inputMessage.value !== '') {
            console.log(pseudo.value);
            socket.emit('writingUsers', pseudo.value);
        } else {
            socket.emit('noWritingUsers', pseudo.value);
        }
    });




</script>
</body>
</html>
