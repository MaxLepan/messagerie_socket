<!DOCTYPE html>
<html lang="en">
<head>
    <title>Socket.IO chat</title>
    <style>
        body {
            margin: 0;
            padding-bottom: 3rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #message {
            background: rgba(0, 0, 0, 0.15);
            padding: 0.25rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            height: 3rem;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        #input {
            border: none;
            padding: 0 1rem;
            flex-grow: 1;
            border-radius: 2rem;
            margin: 0.25rem;
        }

        #input:focus {
            outline: none;
        }

        #message > button {
            background: #333;
            border: none;
            padding: 0 1rem;
            margin: 0.25rem;
            border-radius: 3px;
            outline: none;
            color: #fff;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #messages > li {
            padding: 0.5rem 1rem;
        }

        #messages > li:nth-child(odd) {
            background: #efefef;
        }

        .image_user {
            width: 50px;
        }
    </style>
</head>
<body>
<form action="" id="login">
    <input id="email" placeholder="Email" type="email" required>
    <input id="pseudo" autocomplete="off" placeholder="Pseudo" required>
    <input type="submit">
</form>
<div id="connectedUser"></div>

<ul id="messages"></ul>

<div>
    <h4>Online users</h4>
    <ul id="onlineUsers"></ul>
</div>

<div>
    <div id="writerArea"></div>
<form id="message" action="">
    <input id="input" autocomplete="off" /><button>Send</button>
</form>
</div>

<script src="socket.io.min.js"></script>
<script src="md5.min.js"></script>
<script>
    //moi
    let socket = io("ws://localhost:3000");
    let message = document.getElementById('message');
    let messages = document.getElementById('messages');
    let input = document.getElementById('input');
    let login = document.getElementById('login');
    let pseudo = document.getElementById('pseudo');
    let email = document.getElementById('email');
    let writerArea = document.getElementById('writerArea');

    let connectedUser = document.getElementById('connectedUser');
    let onlineUsers = document.getElementById('onlineUsers');

    let formData = new FormData ();
    let emailData = formData.get("email");
    let hash = md5(emailData);


    function myMessage(item, msg) {
        item.innerHTML =
            "<div>" +
            "<div><h3>"+ msg["user"] +"</h3></div>" +
            "<div>"+ msg["message"] +"</div>" +
            "</div>"+
            "<div><img class='image_user' src='https://www.gravatar.com/avatar/"+hash+"'></div>";
    }


    function otherMessage(item, msg){
        item.innerHTML = "<div><img class='image_user' src='https://www.gravatar.com/avatar/"+hash+"'></div>" +
            "<div>" +
            "<div><h3>" + msg["user"] + "</h3></div>" +
            "<div>" + msg["message"] + "</div>" +
            "</div>"
    }

    message.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
            socket.emit('chat message', {message: input.value, userMail: email.value, user: pseudo.value});
            input.value = '';
            socket.emit('noWritingUsers', pseudo.value);
        }
    });

    socket.on('chat message', function(msg) {
        var item = document.createElement('li');
        if (email.value === msg['userMail']) {
            myMessage(item, msg);
        } else {
            otherMessage(item, msg);
        }
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
    });

    socket.on('writingUsers', (writers) => {
    if (writers.length !== 0) {
        writerArea.innerHTML = "<div>"
        for (let i = 0; i < writers.length; i++) {
            if (writers[i] !== pseudo.value) {
                writerArea.innerHTML += writers[i] + ", ";
            }

        }
        writerArea.innerHTML += " is typing.</div>";
    } else {
        writerArea.innerHTML = '';
    }

    })

    socket.on('disconnected', (user) => {
        connectedUser.innerHTML = user['pseudo'] + " is disconnected";

    })

    login.addEventListener('submit', function(e) {
        e.preventDefault();
        socket.emit('newUser', {
            pseudo: pseudo.value,
            email: email.value,
            img: '',
            socketKey: socket['id'],
            online: true
        });
    });

    socket.on('users', () => {

        socket.on('draw old messages', (msg) =>{
            //console.log(msg.length);

            for ( let i = 0; i< msg.length;i++){
                let item = document.createElement('li');
                if (email.value === msg[i]['userMail']) {
                    myMessage(item, msg[i]);
                } else {
                    otherMessage(item, msg[i]);
                }
                messages.appendChild(item);
                window.scrollTo(0, document.body.scrollHeight);
            }
        })

    })

    socket.on('participants', (users) => {
        let connectedUsers = onlineUsers;
        connectedUsers.innerHTML = "";

        users.forEach(user => {
            connectedUsers.innerHTML += `
            <li> <div><img class='image_user' src='https://www.gravatar.com/avatar/${hash}'></div>
            <p>${user.pseudo}</p>
            </li>`
        })
    })

    socket.on('connectedUsers', (users) => {

        connectedUser.innerHTML = users['pseudo'] + " is connected.";

        console.log(users);

    })

    input.addEventListener('input', () => {
        console.log("typing");
        if (input.value !== '') {
            console.log(pseudo.value);
            socket.emit('writingUsers', pseudo.value);
        } else {
            socket.emit('noWritingUsers', pseudo.value);
        }
    })



</script>
</body>
</html>
